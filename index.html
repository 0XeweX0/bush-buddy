<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bush Buddy PRO - AI Evolution</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const apiKey = ""; // API –∫–ª—é—á –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ–º –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

        const localData = localStorage.getItem('bushbuddy_v5_data');
        window.state = localData ? JSON.parse(localData) : {
            userName: "–ú–∞–Ω–¥—Ä—ñ–≤–Ω–∏–∫",
            inventory: [],
            journal: [],
            brightness: 60,
            activeTab: 'home',
            lastWeather: null
        };

        const marketItems = [
            { id: 1, name: "–ù–æ–∂—ñ Mora (Rozetka)", icon: "üî™", desc: "–®–≤–µ–¥—Å—å–∫–∞ —è–∫—ñ—Å—Ç—å, —ñ–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –±—É—à–∫—Ä–∞—Ñ—Ç—É", link: "https://rozetka.com.ua/ua/knives/c80111/producer=mora/" },
            { id: 2, name: "–°–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è (Ibis)", icon: "üèπ", desc: "–ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–µ –º–∏—Å–ª–∏–≤—Å—å–∫–µ —Ç–∞ –ø–æ—Ö—ñ–¥–Ω–µ –µ–∫—ñ–ø—ñ—Ä—É–≤–∞–Ω–Ω—è", link: "https://ibis.net.ua/ua/products/turisticheskie-aksessuary/" },
            { id: 3, name: "–°–æ–∫–∏—Ä–∏ —Ç–∞ –ø–∏–ª–∫–∏ (Ibis)", icon: "ü™ì", desc: "–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –¥–µ—Ä–µ–≤–æ–º —É –ª—ñ—Å—ñ", link: "https://ibis.net.ua/ua/products/topory-i-pily/" },
            { id: 4, name: "–ü–∞–ª—å–Ω–∏–∫–∏ —Ç–∞ –≥–∞–∑ (Rozetka)", icon: "üî•", desc: "–°–∏—Å—Ç–µ–º–∏ –ø—Ä–∏–≥–æ—Ç—É–≤–∞–Ω–Ω—è —ó–∂—ñ Jetboil —Ç–∞ —ñ–Ω—à—ñ", link: "https://rozetka.com.ua/ua/turisticheskie-gorelki/c82664/" },
            { id: 5, name: "–ö—Ä–µ—Å–∞–ª–∞ —Ç–∞ —Ä–æ–∑–ø–∞–ª", icon: "‚ú®", desc: "–¢—Ä–∞–¥–∏—Ü—ñ–π–Ω—ñ –∑–∞—Å–æ–±–∏ –¥–æ–±—É–≤–∞–Ω–Ω—è –≤–æ–≥–Ω—é", link: "https://ibis.net.ua/ua/products/turisticheskie-aksessuary/search/kresalo/" },
            { id: 6, name: "–¢–µ–Ω—Ç–∏ —Ç–∞ –≥–∞–º–∞–∫–∏", icon: "‚õ∫", desc: "–õ–µ–≥–∫—ñ —É–∫—Ä–∏—Ç—Ç—è –¥–ª—è –∞–≤—Ç–æ–Ω–æ–º–Ω–∏—Ö –Ω–æ—á—ñ–≤–µ–ª—å", link: "https://rozetka.com.ua/ua/palatki-i-tenty/c80182/vid-70650=tent/" }
        ];

        let db, auth, appId, cameraStream;

        // --- GEMINI API CORE ---
        async function callGemini(prompt, base64Image = null, isTts = false, tools = null) {
            let url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            let payload = { contents: [{ parts: [{ text: prompt }] }] };

            if (tools) {
                payload.tools = tools;
            }

            if (isTts) {
                url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { 
                        responseModalities: ["AUDIO"],
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                    }
                };
            }

            if (base64Image) {
                payload.contents[0].parts.push({ inlineData: { mimeType: "image/jpeg", data: base64Image } });
            }

            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('API failed');
                    const data = await response.json();
                    
                    if (isTts) {
                        return data.candidates[0].content.parts[0].inlineData.data;
                    }
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    if (i === 4) throw e;
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
        }

        // --- WEATHER FEATURE ---
        window.getWeatherUpdate = async () => {
            window.notify("–ó–∞–ø–∏—Ç –º–µ—Ç–µ–æ–¥–∞–Ω–∏—Ö...");
            try {
                const prompt = "–Ø–∫–∞ –∑–∞—Ä–∞–∑ –ø–æ–≥–æ–¥–∞ –≤ –£–∫—Ä–∞—ó–Ω—ñ? –ù–∞–¥–∞–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É, –æ–ø–∏—Å –Ω–µ–±–∞ —Ç–∞ –æ–¥–Ω—É –ø–æ—Ä–∞–¥—É –¥–ª—è –±—É—à–∫—Ä–∞—Ñ—Ç–µ—Ä–∞. –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –∫–æ—Ä–æ—Ç–∫–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é.";
                const res = await callGemini(prompt, null, false, [{ "google_search": {} }]);
                window.state.lastWeather = res;
                window.saveData();
                window.renderTab('home');
                window.modal("üå•Ô∏è –ü–†–û–ì–ù–û–ó –ü–û–ì–û–î–ò", res, true);
            } catch (e) {
                window.notify("–ü–æ–º–∏–ª–∫–∞ –ø–æ–≥–æ–¥–∏");
            }
        };

        // –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞—É–¥—ñ–æ
        async function playTts(text) {
            try {
                window.notify("–ì–µ–Ω–µ—Ä—É—é –≥–æ–ª–æ—Å...");
                const base64Audio = await callGemini(`–°–∫–∞–∂–∏ –≤–ø–µ–≤–Ω–µ–Ω–æ: ${text}`, null, true);
                const binary = atob(base64Audio);
                const array = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);
                
                const wavHeader = new ArrayBuffer(44);
                const view = new DataView(wavHeader);
                view.setUint32(0, 0x46464952, true); // RIFF
                view.setUint32(4, 36 + array.length, true);
                view.setUint32(8, 0x45564157, true); // WAVE
                view.setUint32(12, 0x20746d66, true); // fmt 
                view.setUint16(20, 1, true); // PCM
                view.setUint16(22, 1, true); // Mono
                view.setUint32(24, 24000, true); // Sample Rate
                view.setUint32(28, 48000, true); // Byte Rate
                view.setUint16(32, 2, true); // Block Align
                view.setUint16(34, 16, true); // Bits per sample
                view.setUint32(36, 0x61746164, true); // data
                view.setUint32(40, array.length, true);

                const blob = new Blob([wavHeader, array], { type: 'audio/wav' });
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
            } catch (e) { window.notify("–ü–æ–º–∏–ª–∫–∞ –∑–≤—É–∫—É"); }
        }

        window.getAiRoutePlan = async () => {
            const items = window.state.inventory.map(i => i.name).join(", ");
            window.notify("–®–Ü –∞–Ω–∞–ª—ñ–∑—É—î —Ä–µ—Å—É—Ä—Å–∏...");
            try {
                const plan = await callGemini(`–ú—ñ–π —ñ–Ω–≤–µ–Ω—Ç–∞—Ä: ${items || '–ø–æ—Ä–æ–∂–Ω—å–æ'}. –°–∫–ª–∞–¥–∏ –∫–æ—Ä–æ—Ç–∫–∏–π –ø–ª–∞–Ω –≤–∏–∂–∏–≤–∞–Ω–Ω—è –≤ –ª—ñ—Å—ñ –Ω–∞ –Ω—ñ—á. 3 –ø—É–Ω–∫—Ç–∏. –¢—ñ–ª—å–∫–∏ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é.`);
                window.modal("‚ú® –®–Ü –ü–õ–ê–ù –í–ò–ñ–ò–í–ê–ù–ù–Ø", plan, true);
            } catch (e) { window.notify("–ü–æ–º–∏–ª–∫–∞ Gemini"); }
        };

        window.getAiTip = async () => {
            const btn = document.getElementById('ai-tip-btn');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            try {
                const tip = await callGemini("–î–∞–π –æ–¥–Ω—É –ø–æ—Ä–∞–¥—É –∑ –±—É—à–∫—Ä–∞—Ñ—Ç—É –¥–ª—è –£–∫—Ä–∞—ó–Ω–∏. 1 —Ä–µ—á–µ–Ω–Ω—è.");
                window.modal("‚ú® –ü–û–†–ê–î–ê –î–ù–Ø", tip, true);
            } catch (e) { window.notify("–ü–æ–º–∏–ª–∫–∞"); } finally { btn.innerHTML = original; }
        };

        window.analyzeInventory = async () => {
            const items = window.state.inventory.map(i => i.name).join(", ");
            window.notify("–ê—É–¥–∏—Ç –±–∞–≥–∞–∂—É...");
            try {
                const prompt = items 
                    ? `–ú—ñ–π –Ω–∞–±—ñ—Ä: ${items}. –ß–æ–≥–æ –Ω–µ –≤–∏—Å—Ç–∞—á–∞—î –¥–ª—è –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –ø–æ—Ö–æ–¥—É? –ù–∞–∑–≤–∏ –æ–¥–Ω—É —Ä—ñ—á. –£–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é.`
                    : "–ó —á–æ–≥–æ –º–µ–Ω—ñ –ø–æ—á–∞—Ç–∏ –∑–±–∏—Ä–∞—Ç–∏ –Ω–∞–±—ñ—Ä –¥–ª—è –≤–∏–∂–∏–≤–∞–Ω–Ω—è? –ù–∞–∑–≤–∏ 3 –±–∞–∑–æ–≤—ñ —Ä–µ—á—ñ.";
                const res = await callGemini(prompt);
                window.modal("‚ú® –®–Ü –ê–£–î–ò–¢", res, true);
            } catch (e) { window.notify("–ü–æ–º–∏–ª–∫–∞"); }
        };

        window.processImageScan = async (base64) => {
            document.getElementById('scan-status').innerText = "–ê–ù–ê–õ–Ü–ó –û–ë'–Ñ–ö–¢–ê...";
            try {
                const result = await callGemini("–©–æ –Ω–∞ —Ñ–æ—Ç–æ? –ß–∏ –∫–æ—Ä–∏—Å–Ω–µ —Ü–µ –¥–ª—è –≤–∏–∂–∏–≤–∞–Ω–Ω—è –≤ –£–∫—Ä–∞—ó–Ω—ñ? –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –∫–æ—Ä–æ—Ç–∫–æ —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é.", base64);
                window.closeScanner();
                window.modal("‚ú® –®–Ü –†–û–ó–ü–Ü–ó–ù–ê–í–ê–ù–ù–Ø", result, true);
            } catch (e) {
                window.notify("–ü–æ–º–∏–ª–∫–∞ –∞–Ω–∞–ª—ñ–∑—É");
                window.closeScanner();
            }
        };

        window.modal = (title, text, allowTts = false) => {
            const m = document.getElementById('global-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-text').innerText = text;
            const ttsBtn = document.getElementById('modal-tts-btn');
            if (allowTts) {
                ttsBtn.classList.remove('hidden');
                ttsBtn.onclick = () => playTts(text);
            } else {
                ttsBtn.classList.add('hidden');
            }
            m.classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('global-modal').classList.add('hidden');

        async function initFirebase() {
            try {
                if (typeof __firebase_config === 'undefined') return;
                const config = JSON.parse(__firebase_config);
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'bush-ai-v7';

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else { await signInAnonymously(auth); }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const snap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'));
                        if (snap.exists()) {
                            window.state = { ...window.state, ...snap.data() };
                            window.applySettings();
                            window.renderTab(window.state.activeTab);
                        }
                    }
                });
            } catch (e) { console.warn("Offline Mode Active"); }
        }

        window.saveData = async () => {
            localStorage.setItem('bushbuddy_v5_data', JSON.stringify(window.state));
            if (auth?.currentUser && db) {
                await setDoc(doc(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'profile', 'data'), window.state);
            }
        };

        window.applySettings = () => {
            const overlay = document.getElementById('app-overlay');
            if (overlay) overlay.style.background = `rgba(0,0,0, ${window.state.brightness / 100})`;
            document.getElementById('user-tag').innerText = window.state.userName;
            document.getElementById('bag-badge').innerText = window.state.inventory.length;
        };

        window.updateVal = (key, val) => {
            window.state[key] = val;
            window.applySettings();
            window.saveData();
        };

        window.addToBag = (id) => {
            const item = marketItems.find(i => i.id === id);
            window.state.inventory.push({...item, uid: Date.now()});
            window.saveData();
            window.applySettings();
            window.notify(`–î–æ–¥–∞–Ω–æ: ${item.name}`);
        };

        window.removeItem = (index) => {
            window.state.inventory.splice(index, 1);
            window.saveData();
            window.applySettings();
            window.renderTab('bag');
        };

        window.renderTab = (id) => {
            window.state.activeTab = id;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('btn-' + id);
            if(btn) btn.classList.add('active');

            const content = document.getElementById('main-content');
            if (!content) return;

            if(id === 'home') {
                content.innerHTML = `
                    <div class="animate-in space-y-6">
                        <!-- –ü–æ–≥–æ–¥–∞ Widget -->
                        <div onclick="window.getWeatherUpdate()" class="glass p-5 border-l-4 border-blue-500 bg-gradient-to-r from-blue-500/10 to-transparent cursor-pointer active:scale-95 transition-all">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-[9px] font-black uppercase text-blue-400 tracking-widest mb-1">–ú–ï–¢–ï–û-–î–ê–ù–Ü</h3>
                                    <p class="text-[10px] font-bold text-white italic truncate max-w-[220px]">
                                        ${window.state.lastWeather || '–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑—É'}
                                    </p>
                                </div>
                                <i class="fas fa-cloud-sun text-blue-400 text-lg"></i>
                            </div>
                        </div>

                        <div class="glass p-6 border-b-4 border-green-500 relative overflow-hidden bg-gradient-to-br from-green-500/10 to-transparent">
                            <h2 class="text-[9px] font-black uppercase text-gray-500 tracking-widest mb-1">–°—Ç–∞–Ω –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ</h2>
                            <p class="text-xl font-black uppercase tracking-tighter">–ï–∫—Å–ø–µ–¥–∏—Ü—ñ—è –ê–∫—Ç–∏–≤–æ–≤–∞–Ω–∞</p>
                            <button id="ai-tip-btn" onclick="window.getAiTip()" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-green-500 flex items-center justify-center text-black shadow-lg animate-pulse">
                                <i class="fas fa-brain text-sm"></i>
                            </button>
                        </div>

                        <div onclick="window.getAiRoutePlan()" class="glass p-5 border-l-4 border-white/20 flex items-center justify-between cursor-pointer active:scale-95 transition-all bg-white/5">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-map-marked-alt text-green-500 text-xl"></i>
                                <span class="text-[10px] font-black uppercase tracking-widest">‚ú® –®–Ü –ü–ª–∞–Ω –í–∏–∂–∏–≤–∞–Ω–Ω—è</span>
                            </div>
                            <i class="fas fa-sparkles text-green-500 animate-pulse"></i>
                        </div>

                        <div onclick="window.openScanner()" class="glass p-6 flex items-center justify-between cursor-pointer border-l-4 border-green-500 bg-white/5">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-black shadow-lg shadow-green-500/40">
                                    <i class="fas fa-expand"></i>
                                </div>
                                <div>
                                    <h3 class="text-xs font-black uppercase tracking-widest">‚ú® –®–Ü –°–ö–ê–ù–ï–† –û–ë'–Ñ–ö–¢–Ü–í</h3>
                                    <p class="text-[8px] text-gray-400 mt-1 uppercase font-bold">–ê–Ω–∞–ª—ñ–∑—É–π —Å–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è —Ç–∞ –ø—Ä–∏—Ä–æ–¥—É</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if(id === 'shop') {
                content.innerHTML = `<div class="animate-in space-y-4 pb-20">
                    <h2 class="text-[10px] font-black uppercase text-center opacity-40 mb-4 tracking-widest">–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å –ë–∞–∑–∏</h2>
                    ${marketItems.map(item => `
                        <div class="glass overflow-hidden border border-white/5">
                            <div class="p-5 flex items-start justify-between bg-white/5">
                                <div class="flex items-center gap-4">
                                    <div class="text-3xl">${item.icon}</div>
                                    <div class="max-w-[180px]">
                                        <div class="text-[10px] font-black uppercase text-white">${item.name}</div>
                                        <div class="text-[8px] text-gray-400 mt-1 uppercase tracking-tight">${item.desc}</div>
                                    </div>
                                </div>
                                <button onclick="addToBag(${item.id})" class="bg-white/10 text-white w-10 h-10 rounded-full flex items-center justify-center active:bg-green-500 active:text-black transition-all">
                                    <i class="fas fa-plus text-[10px]"></i>
                                </button>
                            </div>
                        </div>`).join('')}
                </div>`;
            } else if(id === 'bag') {
                content.innerHTML = `
                    <div class="animate-in space-y-4 pb-24">
                        <button onclick="window.analyzeInventory()" class="w-full py-5 bg-green-500 text-black text-[9px] font-black uppercase rounded-2xl shadow-xl shadow-green-500/30 active:scale-95 transition-all flex items-center justify-center gap-3">
                            <i class="fas fa-shield-alt"></i> ‚ú® –®–Ü –ê—É–¥–∏—Ç –°–ø–æ—Ä—è–¥–∂–µ–Ω–Ω—è
                        </button>
                        ${window.state.inventory.length ? window.state.inventory.map((item, i) => `
                            <div class="glass p-4 flex items-center justify-between bg-white/5 border-l-2 border-green-500/50">
                                <div class="flex items-center gap-4">
                                    <span class="text-xl">${item.icon}</span>
                                    <span class="text-[10px] font-black uppercase">${item.name}</span>
                                </div>
                                <button onclick="removeItem(${i})" class="text-red-500/40 p-2 hover:text-red-500"><i class="fas fa-trash"></i></button>
                            </div>
                        `).join('') : '<div class="text-center py-24 opacity-20 text-[10px] uppercase font-black tracking-widest">–í–∞—à —Ä—é–∫–∑–∞–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π</div>'}
                    </div>`;
            } else if(id === 'opts') {
                content.innerHTML = `
                    <div class="animate-in glass p-6 space-y-6">
                        <h2 class="text-xs font-black uppercase tracking-widest border-b border-white/10 pb-4">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –°–∏—Å—Ç–µ–º–∏</h2>
                        <div>
                            <label class="text-[8px] font-black uppercase text-gray-500 tracking-widest block mb-2">–ü–æ–∑–∏–≤–Ω–∏–π –û–ø–µ—Ä–∞—Ç–æ—Ä–∞</label>
                            <input type="text" value="${window.state.userName}" onchange="updateVal('userName', this.value)" class="w-full bg-white/5 border border-white/10 p-4 rounded-xl text-[10px] outline-none text-white focus:border-green-500">
                        </div>
                        <div>
                            <label class="text-[8px] font-black uppercase text-gray-500 tracking-widest block mb-2">–ù—ñ—á–Ω–∏–π —Ä–µ–∂–∏–º (Alpha)</label>
                            <input type="range" min="0" max="95" value="${window.state.brightness}" oninput="updateVal('brightness', this.value)" class="w-full h-1 accent-green-500 my-4">
                        </div>
                    </div>`;
            }
        };

        window.notify = (msg) => {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            const n = document.createElement('div');
            n.className = `notification fixed bottom-32 left-1/2 -translate-x-1/2 z-[300] px-8 py-3 rounded-full text-[8px] font-black uppercase bg-white text-black shadow-2xl animate-in border-b-2 border-green-500`;
            n.innerText = msg;
            document.body.appendChild(n);
            setTimeout(() => { n.style.opacity = '0'; n.style.transform = 'translate(-50%, 20px)'; setTimeout(() => n.remove(), 400); }, 3000);
        };

        window.onload = () => {
            window.applySettings();
            window.renderTab('home');
            initFirebase();
        };

        window.openScanner = async () => {
            const container = document.getElementById('scanner-ui');
            const video = document.getElementById('camera-feed');
            container.classList.remove('hidden');
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = cameraStream;
            } catch (err) { window.notify("–î–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ"); container.classList.add('hidden'); }
        };

        window.closeScanner = () => {
            if (cameraStream) cameraStream.getTracks().forEach(t => t.stop());
            document.getElementById('scanner-ui').classList.add('hidden');
        };

        window.captureScan = async () => {
            const video = document.getElementById('camera-feed');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            window.processImageScan(canvas.toDataURL('image/jpeg').split(',')[1]);
        };
    </script>

    <style>
        :root { --accent: #22c55e; }
        body { background: #000; color: #fff; font-family: 'Montserrat', sans-serif; height: 100vh; overflow: hidden; margin: 0; }
        #app-bg { position: fixed; inset: 0; background: url('https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=2560&auto=format&fit=crop') center/cover no-repeat; z-index: -2; }
        #app-overlay { position: fixed; inset: 0; z-index: -1; background: rgba(0,0,0,0.85); transition: 0.5s; }
        .glass { background: rgba(10, 10, 10, 0.7); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 28px; }
        .nav-bar { background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(20px); height: 100px; border-top: 1px solid rgba(255,255,255,0.05); }
        .nav-btn { color: #555; transition: 0.3s; position: relative; }
        .nav-btn.active { color: var(--accent); }
        .animate-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #scanner-ui { position: fixed; inset: 0; z-index: 1000; background: #000; }
        #camera-feed { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
        .viewfinder { position: absolute; inset: 60px; border: 1px solid rgba(34, 197, 94, 0.5); border-radius: 40px; box-shadow: 0 0 0 2000px rgba(0,0,0,0.5); }
        .viewfinder::after { content: ''; position: absolute; inset: -2px; border: 4px solid var(--accent); border-radius: 40px; clip-path: polygon(0 0, 30% 0, 30% 10%, 70% 10%, 70% 0, 100% 0, 100% 30%, 90% 30%, 90% 70%, 100% 70%, 100% 100%, 70% 100%, 70% 90%, 30% 90%, 30% 100%, 0 100%, 0 70%, 10% 70%, 10% 30%, 0 30%); }
        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body>

<div id="app-bg"></div>
<div id="app-overlay"></div>

<div id="global-modal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center p-6 bg-black/98 backdrop-blur-2xl">
    <div class="glass w-full max-w-sm p-10 border-t-8 border-green-500 animate-in relative shadow-[0_0_50px_rgba(34,197,94,0.1)]">
        <button id="modal-tts-btn" class="absolute top-8 right-8 text-green-500 text-xl active:scale-150 transition-transform">
            <i class="fas fa-volume-up"></i>
        </button>
        <h3 id="modal-title" class="text-[12px] font-black uppercase text-green-500 mb-8 tracking-[0.2em] pr-12"></h3>
        <p id="modal-text" class="text-[13px] leading-relaxed text-gray-100 mb-10 font-medium italic"></p>
        <button onclick="window.closeModal()" class="w-full py-5 bg-white/5 border border-white/10 rounded-2xl text-[10px] font-black uppercase tracking-[0.3em] hover:bg-white/10 transition-all active:scale-95">–ó–ê–ö–†–ò–¢–ò –¢–ï–†–ú–Ü–ù–ê–õ</button>
    </div>
</div>

<div id="scanner-ui" class="hidden">
    <video id="camera-feed" autoplay playsinline></video>
    <div class="viewfinder"></div>
    <div id="scan-status" class="absolute top-24 left-0 right-0 text-center text-[11px] font-black uppercase text-green-500 tracking-[0.3em] animate-pulse">–ê–ù–ê–õ–Ü–ó –°–ï–†–ï–î–û–í–ò–©–ê...</div>
    <div class="absolute bottom-16 left-0 right-0 px-12 flex justify-between items-center">
        <button onclick="window.closeScanner()" class="w-16 h-16 rounded-full bg-white/10 text-white flex items-center justify-center text-xl backdrop-blur-md"><i class="fas fa-times"></i></button>
        <button onclick="window.captureScan()" class="w-24 h-24 rounded-full bg-white border-[12px] border-white/30 shadow-[0_0_30px_rgba(255,255,255,0.3)] active:scale-90 transition-all"></button>
        <div class="w-16 h-16"></div>
    </div>
</div>

<div class="flex flex-col h-screen relative">
    <header class="px-10 pt-16 pb-8 flex justify-between items-center relative z-10">
        <div class="flex items-center gap-5">
            <div class="w-14 h-14 bg-green-500 rounded-[20px] flex items-center justify-center text-black shadow-[0_10px_30px_rgba(34,197,94,0.3)]">
                <i class="fas fa-mountain-sun text-xl"></i>
            </div>
            <div>
                <h1 class="font-black text-[18px] uppercase tracking-tighter leading-none">BUSH <span class="text-green-500">CORE</span></h1>
                <p id="user-tag" class="text-[9px] text-gray-500 font-bold uppercase tracking-[0.2em] mt-1.5"></p>
            </div>
        </div>
        <div class="text-[10px] text-green-500/50 font-black tracking-widest animate-pulse">ONLINE</div>
    </header>

    <main id="main-content" class="flex-1 overflow-y-auto px-10 py-2 pb-36 relative z-10"></main>

    <nav class="nav-bar fixed bottom-0 left-0 right-0 flex justify-around items-center px-6 z-50">
        <button onclick="renderTab('home')" id="btn-home" class="nav-btn flex flex-col items-center gap-2">
            <i class="fas fa-home-alt text-xl"></i>
            <span class="text-[8px] font-black uppercase tracking-widest">–•–ê–ë</span>
        </button>
        <button onclick="renderTab('shop')" id="btn-shop" class="nav-btn flex flex-col items-center gap-2">
            <i class="fas fa-cart-flatbed text-xl"></i>
            <span class="text-[8px] font-black uppercase tracking-widest">–ú–ê–†–ö–ï–¢</span>
        </button>
        <button onclick="window.openScanner()" class="nav-btn flex flex-col items-center gap-2">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center -mt-12 border-[6px] border-[#000] shadow-[0_15px_40px_rgba(34,197,94,0.4)] transition-transform active:scale-90">
                <i class="fas fa-expand-arrows-alt text-2xl text-black"></i>
            </div>
            <span class="text-[8px] font-black uppercase tracking-widest mt-1 text-green-500">AI SCAN</span>
        </button>
        <button onclick="renderTab('bag')" id="btn-bag" class="nav-btn flex flex-col items-center gap-2">
            <i class="fas fa-toolbox text-xl"></i>
            <span class="text-[8px] font-black uppercase tracking-widest">–†–Æ–ö–ó–ê–ö</span>
            <div id="bag-badge" class="absolute -top-1 -right-2 px-2 py-0.5 bg-green-500 text-black text-[8px] font-black rounded-full shadow-lg">0</div>
        </button>
        <button onclick="renderTab('opts')" id="btn-opts" class="nav-btn flex flex-col items-center gap-2">
            <i class="fas fa-shield-halved text-xl"></i>
            <span class="text-[8px] font-black uppercase tracking-widest">–°–ò–°–¢–ï–ú–ê</span>
        </button>
    </nav>
</div>

</body>
</html>
